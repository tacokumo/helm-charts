apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tacokumo-portal.fullname" . }}-config
  labels:
    {{- include "tacokumo-portal.labels" . | nindent 4 }}
data:
  config.yaml: |
    # Server configuration
    addr: {{ .Values.portal.config.addr }}
    port: {{ .Values.portal.config.port }}
    base_domain: {{ .Values.portal.config.baseDomain }}
    log_level: {{ .Values.portal.config.logLevel }}

    # Database configuration
    portal_db:
      host: ""        # Override via PORTAL_DB_HOST
      port: {{ .Values.portal.config.portalDb.port }}
      user: ""        # Override via PORTAL_DB_USER
      password: ""    # Override via PORTAL_DB_PASSWORD
      db_name: ""     # Override via PORTAL_DB_NAME
      initial_conn_retry: {{ .Values.portal.config.portalDb.initialConnRetry }}

    # Authentication configuration
    auth:
      client_id: ""          # Override via GITHUB_CLIENT_ID
      client_secret: ""      # Override via GITHUB_CLIENT_SECRET
      callback_url: {{ .Values.portal.config.auth.callbackUrl }}
      frontend_url: {{ .Values.portal.config.auth.frontendUrl }}
      github_org: ""         # Override via GITHUB_ORG
      session_ttl: {{ .Values.portal.config.auth.sessionTtl }}
      cookie_secure: {{ .Values.portal.config.auth.cookieSecure }}

    # Redis configuration
    redis:
      host: ""        # Override via REDIS_HOST
      port: {{ .Values.portal.config.redis.port }}
      password: ""    # Override via REDIS_PASSWORD
      db: {{ .Values.portal.config.redis.db }}
      initial_conn_retry: {{ .Values.portal.config.redis.initialConnRetry }}

    # CORS configuration
    cors:
      allow_origins: {{ .Values.portal.config.cors.allowOrigins | quote }}
      allow_methods: {{ .Values.portal.config.cors.allowMethods | quote }}
      allow_headers: {{ .Values.portal.config.cors.allowHeaders | quote }}
      expose_headers: {{ .Values.portal.config.cors.exposeHeaders | quote }}
      allow_credentials: {{ .Values.portal.config.cors.allowCredentials }}
      max_age: {{ .Values.portal.config.cors.maxAge }}

    # TLS configuration
    tls:
      enabled: {{ .Values.portal.config.tls.enabled }}
      cert_file: {{ .Values.portal.config.tls.certFile }}
      key_file: {{ .Values.portal.config.tls.keyFile }}

    {{- if .Values.portal.config.opentelemetry.enabled }}
    # OpenTelemetry configuration
    telemetry:
      enabled: {{ .Values.portal.config.opentelemetry.enabled }}
      otlp_endpoint: {{ .Values.portal.config.opentelemetry.otlpEndpoint }}
      timeout: "5s"
    {{- end }}