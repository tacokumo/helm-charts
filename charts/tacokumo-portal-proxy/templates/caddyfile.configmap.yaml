apiVersion: v1
kind: ConfigMap
metadata:
  name: tacokumo-portal-proxy-caddyfile
  namespace: {{ .Release.Namespace }}
  labels:
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    app.kubernetes.io/name: tacokumo-portal-proxy
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/version: {{ .Chart.AppVersion }}
data:
  Caddyfile: |
    # Global options
    {
        servers {
            metrics
        }
    }

    # Main proxy configuration for path-based routing
    portal.{{ .Values.portalProxy.baseDomain }} {
        # API endpoint routing: /<name>/api/* -> portal-api.<name>.svc.cluster.local
        @api_route path_regexp name ^/([^/]+)/api(/.*)?$
        handle @api_route {
            uri strip_prefix /{re.name.1}/api
            reverse_proxy portal-api.{re.name.1}.svc.cluster.local:1323 {
                header_up Host {upstream_hostport}
            }
        }

        # Frontend routing: /<name>/* -> portal.<name>.svc.cluster.local
        @frontend_route path_regexp name ^/([^/]+)(/.*)?$
        handle @frontend_route {
            uri strip_prefix /{re.name.1}
            reverse_proxy portal.{re.name.1}.svc.cluster.local:80 {
                header_up Host {upstream_hostport}
            }
        }

        # Root path default response
        respond "Portal Proxy Ready - Path-based routing active" 200
    }

    # Metrics endpoint on separate port
    :2019 {
        metrics
    }