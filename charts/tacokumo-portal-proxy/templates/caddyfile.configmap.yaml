apiVersion: v1
kind: ConfigMap
metadata:
  name: tacokumo-portal-proxy-caddyfile
  namespace: {{ .Release.Namespace }}
  labels:
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    app.kubernetes.io/name: tacokumo-portal-proxy
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/version: {{ .Chart.AppVersion }}
data:
  Caddyfile: |
    # Global options
    {
        servers {
            metrics
        }
    }

    # Main proxy configuration
    :80 {
        # Dynamic proxy rule: <name>.{{ .Values.portalProxy.baseDomain }} -> portal.<name>.svc.cluster.local
        @proxy_rule host_regexp name ^([^.]+)\.{{ .Values.portalProxy.baseDomain }}$
        handle @proxy_rule {
            reverse_proxy portal.{re.name.1}.svc.cluster.local:80 {
                header_up Host {upstream_hostport}
            }
        }

        # Default response for non-matching requests
        respond "Portal Proxy Ready" 200
    }

    # Metrics endpoint on separate port
    :2019 {
        metrics
    }